generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["strictUndefinedChecks"]
  runtime         = "bun"
  output          = "./lib/client"
}

generator pothos {
  provider     = "prisma-pothos-types"
  prismaUtils  = true
  clientOutput = "./client" // relative path from pothos output to prisma client
  output       = "./lib/pothos-prisma-types.ts"
}

datasource db {
  provider = "mongodb"
  url      = env("HOF_DATABASE_URL")
}

/// An user/account, needed to view and upload screenshots.
model Creator {
  id                    String            @id @default(auto()) @map("_id") @db.ObjectId
  createdAt             DateTime          @default(now())
  /// Creator's name, public.
  /// Can contain only unicode letters, numbers, spaces, hyphens, apostrophes, and be between 1 and
  /// 20 characters long.
  /// It can otherwise be null and then UIs should display "Anonymous".
  /// Normally this should be `@unique` but MongoDB doesn't support sparse unique indexes so we have
  /// to enforce this in the application instead.
  creatorName           String?
  /// Slug version of `Creator.creatorName`, used for efficient case-insensitive searches, to
  /// enforce uniqueness in all cases.
  /// Also could be used for vanity URLs in the future.
  creatorNameSlug       String?
  /// Iif the creator name uses non-Latin characters and was automatically translated, this will be
  // set to the guessed two-letter locale code.
  creatorNameLocale     String?
  /// Latinized version of creator name if the original uses non-Latin characters.
  /// Null if not applicable or there was an error calling translation APIs.
  creatorNameLatinized  String?
  /// English-translated creator name if the original uses non-Latin characters.
  /// Null if not applicable or there was an error calling translation APIs.
  creatorNameTranslated String?
  /// Whether `creatorNameLatinized` or `creatorNameTranslated` need to be (re)generated.
  needsTranslation      Boolean           @default(true)
  /// Whether the user is allowed to reset their `creatorId`: the next time the user logs in,
  /// whatever they used to log in will be their new `creatorId`, and `allowCreatorIdReset` will be
  /// reset to false.
  allowCreatorIdReset   Boolean           @default(false)
  /// This is our "Creator ID" and also the Paradox account ID.
  /// This is how users are identified and authenticated, and plays the role of a password or API
  /// token, as this account ID is only known to an authenticated Paradox user.
  creatorId             String            @unique
  /// The provider of the `Creator.creatorId`, either local (random ID generated by the mod and
  /// managed by the user) or Paradox account GUID.
  creatorIdProvider     CreatorIdProvider
  /// Whether the Creator is a supporter of the project.
  /// Currently this only means they sent screenshots before public release.
  isSupporter           Boolean           @default(false)
  /// All unique hardware IDs used by this Creator, used to ban an Creator and mitigate hostile
  /// multi-accounting, along with `Creator.ips`.
  /// Most-recently used HWID is first in the list.
  hwids                 String[]
  /// Same purpose as `Creator.hwids`, but for the IP addresses.
  /// Contrarily to hardware IDs, IPs are harder to spoof so this adds as an additional layer of
  /// security.
  /// Most-recently used IP is first in the list.
  ips                   String[]
  /// Array of social accounts of the Creator.
  socials               CreatorSocial[]
  /// JSON object containing the latest known mod settings this user used.
  /// Used to better understand the mod's usage.
  modSettings           Json?
  /// One to many relationship with posted Screenshots.
  screenshots           Screenshot[]      @relation("screenshots")
  /// One to many relationship with reported Screenshots.
  reportedScreenshots   Screenshot[]      @relation("reports")
  /// One to many relationship with Bans targeting the Creator.
  bans                  Ban[]
  /// One to many relationship with Favorites.
  favorites             Favorite[]
  /// One to many relationship with Views, the screenshots the Creator has seen.
  viewedScreenshots     View[]

  @@index([creatorName])
  @@index([creatorNameSlug])
  @@index([creatorIdProvider])
  @@index([isSupporter])
  @@map("creators")
}

enum CreatorIdProvider {
  local
  paradox
}

/// A social link for a Creator.
type CreatorSocial {
  /// Platform, ex. "youtube", "twitch", etc.
  platform String
  /// Full link to the webpage for the creator's page, ex. "https://youtube.com/@Shaun_vids"
  link     String
  /// Number of times we redirected to the link.
  clicks   Int    @default(0)
}

/// A screenshot uploaded by a Creator.
model Screenshot {
  id                   String                      @id @default(auto()) @map("_id") @db.ObjectId
  createdAt            DateTime                    @default(now())
  /// Whether that screenshot was manually approved by an admin.
  /// If true, users won't be able to signal that screenshot again.
  isApproved           Boolean                     @default(false)
  /// Whether an user has reported the Screenshot as inappropriate.
  /// If true, the Screenshot is hidden from the public until an admin reviews it and decides to
  /// reset the flag or take action.
  isReported           Boolean                     @default(false)
  /// Creator who reported the Screenshot.
  /// Useful to track users who abuse the report feature and eventually reset a bunch of reports if
  /// they aren't justified.
  reportedById         String?                     @db.ObjectId
  reportedBy           Creator?                    @relation("reports", fields: [reportedById], references: [id], onDelete: SetNull)
  /// Number of favorites the Screenshot has received.
  favoritesCount       Int                         @default(0)
  /// Percentage of users who favorited the Screenshot when they saw it.
  /// Math.round(favoritesCount / uniqueViewsCount * 100)
  favoritingPercentage Float                       @default(0)
  /// Number of views the Screenshot has received, deduplicated by Creator ID (a same person viewing
  /// the same screenshot multiple times counts once).
  uniqueViewsCount     Int                         @default(0)
  /// Number of views the Screenshot has received in total, not deduplicated by Creator ID.
  viewsCount           Int                         @default(0)
  /// Hardware ID of the user who uploaded the Screenshot.
  /// Used in case a user is multi-accounting (which is allowed), to keep track of all the
  /// screenshots uploaded by a same person to apply quota even across multiple accounts.
  /// Null if the screenshot was created programmatically by an admin (like CLI-imported
  /// screenshots).
  hwid                 String?
  /// Same purpose as `Screenshot.hwid`, but for the IP address.
  ip                   String?
  creatorId            String                      @db.ObjectId
  creator              Creator                     @relation("screenshots", fields: [creatorId], references: [id], onDelete: Cascade)
  /// Name of the city.
  /// Can contain only unicode letters, numbers, spaces, hyphens, apostrophes, commas, and be
  /// between 1 and 20 characters long.
  cityName             String
  /// Iif the city name uses non-Latin characters and was automatically translated, this will be set
  /// to the guessed two-letter locale code.
  cityNameLocale       String?
  /// Latinized version of the city name if the original uses non-Latin characters.
  /// Null if not applicable or there was an error calling translation APIs.
  cityNameLatinized    String?
  /// English-translated city name if the original uses non-Latin characters.
  /// Null if not applicable or there was an error calling translation APIs.
  cityNameTranslated   String?
  /// Whether `cityNameLatinized` or `cityNameTranslated` need to be (re)generated.
  needsTranslation     Boolean                     @default(true)
  /// City milestone. Goes from 0 (Founding) to 20 (Megalopolis).
  /// https://cs2.paradoxwikis.com/Progression#Milestones
  cityMilestone        Int
  /// City population
  cityPopulation       Int
  /// Name of the map that was used for this city.
  /// Nullable: it is not always known, and isn't set either for pictures taken before the fied was
  /// implemented.
  mapName              String?
  /// Highest quality version of the image.
  imageUrl4K           String
  /// URL to the Full HD version of the image.
  imageUrlFHD          String
  /// URL to the thumbnail-size version of the image.
  imageUrlThumbnail    String
  /// User-provided ID of the Paradox Mods asset or map that is showcased in this screenshot, if any.
  showcasedModId       Int?
  /// Image description provided by the user.
  description          String?
  /// Whether `paradoxModIds` is made available to other users.
  shareParadoxModIds   Boolean
  /// Paradox Mods IDs of the active mods when the screenshot was taken.
  paradoxModIds        Int[]
  /// Whether `renderSettings` is made available to other users.
  shareRenderSettings  Boolean
  /// Rendering settings used to take a screenshot.
  /// Each setting that has a non-default value is recorded here, otherwise it is simply not present.
  /// It is a map of "setting code => float value" and validated by application code.
  renderSettings       Json
  /// Schema-less JSON object of metadata sent by the client.
  /// Used for analytical/debugging purposes; not used by business logic.
  metadata             Json
  /// One to many relationship with Favorites.
  favorites            Favorite[]
  /// One to many relationship with Views.
  views                View[]
  /// One to one relationship with ScreenshotSimilarityEmbeddings.
  similarityEmbedding  ScreenshotFeatureEmbedding?

  @@index([createdAt])
  @@index([isReported]) // for "random" aggregation & simple filtering
  @@index([hwid])
  @@index([ip])
  @@index([creatorId]) // for "supporter" aggregation & simple filtering
  @@index([isReported, createdAt]) // for "recent" aggregation when <limit results
  @@index([isReported, favoritingPercentage]) // for "trending" aggregation
  @@index([isReported, viewsCount, createdAt]) // for "archeologist" aggregation and recent aggregation when >limit results
  @@map("screenshots")
}

/// TensorFlow image feature embeddings for screenshots.
/// Separated into another collection to avoid slowing down queries on the main Screenshots
/// collection when projecting all fields.
model ScreenshotFeatureEmbedding {
  /// Contrarily to other models, this ID is not an ObjectId (12 bytes, 96 bits) but an hex string
  /// for 8 bytes (64 bits) (random).
  /// This is because we use IDs as USearch index keys and those must be 64 bits uints, so when
  /// USearch returns the results, we can map back to a database document.
  id           String     @id @map("_id")
  screenshotId String     @unique @db.ObjectId
  screenshot   Screenshot @relation(fields: [screenshotId], references: [id], onDelete: Cascade)
  embedding    Float[]

  @@map("screenshot_feature_embeddings")
}

/// Ban for a Creator and/or an Hardware ID and/or an IP address.
model Ban {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  bannedAt DateTime @default(now())
  reason   String

  /// Either a Creator, an Hardware ID (hwid) or an IP address can be banned.
  /// If creatorId is set, hwid and ip is set too and there is a Ban record for each of those
  /// hwids/ips used by the Creator.
  creatorId String?  @db.ObjectId
  creator   Creator? @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  /// If hwid is set, `creatorId` is null unless the creator was banned and all their associated
  /// hardware IDs were banned too.
  hwid      String?
  /// If the IP address is set, `creatorId` is null unless the creator was banned and all their
  /// associated IP addresses were banned too.
  ip        String?

  @@index([creatorId])
  @@index([hwid])
  @@index([ip])
  @@map("bans")
}

model Favorite {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  favoritedAt  DateTime   @default(now())
  /// Screenshot that was favorited.
  screenshotId String     @db.ObjectId
  screenshot   Screenshot @relation(fields: [screenshotId], references: [id], onDelete: Cascade)
  /// Creator who favorited the Screenshot.
  creatorId    String     @db.ObjectId
  creator      Creator    @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  /// As well as `ip`, prevents multi-accounting for favorites.
  /// Set only when using the mod, where the hardware ID can be determined.
  hwid         String?
  /// As well as `hwid`, prevents multi-accounting for favorites.
  ip           String

  /// These unique indexes will help us find a Favorite on a specific Screenshot set by a specific
  /// user, and prevent multi-accounting for favorites.
  @@unique([screenshotId, creatorId])
  @@unique([screenshotId, hwid])
  @@index([screenshotId, ip])
  /// Index to be used to find all Favorites for a single Screenshot.
  @@index([screenshotId])
  /// Index to be used to find all Favorites for a single Creator.
  @@index([creatorId])
  @@map("favorites")
}

/// Record of a view of a Screenshot, so that we can track views and avoid showing the same
/// screenshot to the same user multiple times.
model View {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  viewedAt     DateTime   @default(now())
  screenshotId String     @db.ObjectId
  screenshot   Screenshot @relation(fields: [screenshotId], references: [id], onDelete: Cascade)
  creatorId    String     @db.ObjectId
  creator      Creator    @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([screenshotId])
  @@index([creatorId])
  // Composite index for querying with date bounds to propose again screenshots the user hasn't seen
  // in a while.
  @@index([creatorId, viewedAt])
  @@map("views")
}

/// A mod from Paradox Mods.
/// The model is meant to cache data on our side to:
/// - Answer to queries faster rather than querying Paradox's API;
/// - Avoid DDoSing Paradox's API when serving playsets that can contain hundreds of mods;
/// - Avoid suffering from Paradox's API outages.
/// - Improve overall DX.
model Mod {
  /// A mod should NOT be referenced from another collection from its `_id` unless there is a
  /// specific reason.
  /// Instead, loose references to `paradoxModId` should be used.
  /// It's the responsibility of `ModsService` to connect mod IDs to Mod records.
  /// We still use an `_id` as `@id` field to play nicer with tooling.
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  /// Mod ID on Paradox Mods.
  paradoxModId       Int      @unique
  /// Display name of the mod.
  name               String
  /// Author's name.
  authorName         String
  /// Short description of the mod.
  shortDescription   String
  /// Thumbnail URL.
  thumbnailUrl       String
  /// Mod tags (ex. "Code Mod", "Building", "European", etc).
  tags               String[]
  /// Number of subscribers to this mod.
  subscribersCount   Int
  /// Number of times we redirected to this mod's page.
  clicks             Int      @default(0)
  /// Last update date of the mod page on Paradox Mods.
  /// This is not necessarily an update of the mod itself, it can be name/description/etc changes.
  /// If that date is more recent than `updatedAt`, we want to update.
  knownLastUpdatedAt DateTime
  /// Last time this document was updated from Paradox's API.
  /// Note that this is not a Prisma `@updatedAt` column as we can update the document (ex. clicks)
  /// without wanting to bump the date.
  lastSyncedAt       DateTime @default(now())

  @@map("mods")
}

/// A record of a database migration that has been executed.
model Migration {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  /// The name of the migration file (in prisma/migrations).
  name       String   @unique
  /// When the migration was executed.
  executedAt DateTime @default(now())

  @@map("migrations")
}
